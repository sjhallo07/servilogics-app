version: '3.8'

x-common-build: &common-build
  restart: "no"
  stdin_open: false
  tty: false

services:
  # ======================
  # REACT NATIVE ANDROID BUILDER
  # ======================
  
  android-builder:
    <<: *common-build
    build:
      context: ./mobile-app
      dockerfile: Dockerfile.android
      args:
        - NODE_VERSION=18
        - ANDROID_SDK_VERSION=34
        - ANDROID_BUILD_TOOLS_VERSION=34.0.0
        - GRADLE_VERSION=8.5
    image: ecme-mobile-builder:latest
    container_name: ecme-android-builder
    environment:
      # Build Configuration
      BUILD_TYPE: ${BUILD_TYPE:-debug}
      APP_NAME: ${APP_NAME:-ECME Mobile}
      APP_VERSION: ${APP_VERSION:-1.0.0}
      APP_VERSION_CODE: ${APP_VERSION_CODE:-1}
      APP_ID: ${APP_ID:-com.ecme.mobile}
      
      # Android Signing (for release builds)
      ANDROID_KEYSTORE_FILE: ${ANDROID_KEYSTORE_FILE:-keystore.jks}
      ANDROID_KEYSTORE_PASSWORD: ${ANDROID_KEYSTORE_PASSWORD}
      ANDROID_KEY_ALIAS: ${ANDROID_KEY_ALIAS}
      ANDROID_KEY_PASSWORD: ${ANDROID_KEY_PASSWORD}
      
      # React Native Environment
      REACT_NATIVE_PACKAGER_HOSTNAME: localhost
      NODE_ENV: production
      EXPO_DEVTOOLS_LISTEN_ADDRESS: 0.0.0.0
      
      # API Configuration
      API_BASE_URL: ${API_BASE_URL:-https://api.ecme.com}
      SENTRY_DSN: ${SENTRY_DSN}
      FIREBASE_CONFIG: ${FIREBASE_CONFIG}
      
      # Performance
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.jvmargs=-Xmx4g"
      GRADLE_USER_HOME: /home/reactnative/.gradle
    volumes:
      # Mount source code
      - ./mobile-app:/home/reactnative/app:rw
      
      # Cache directories (for performance)
      - android_sdk_cache:/opt/android-sdk
      - gradle_cache:/home/reactnative/.gradle
      - node_modules_cache:/home/reactnative/app/node_modules
      
      # Output directory for APKs
      - ./dist/android:/home/reactnative/app/dist:rw
      
      # Docker socket for building within container (if needed)
      - /var/run/docker.sock:/var/run/docker.sock:ro
    working_dir: /home/reactnative/app
    networks:
      - mobile-build-network
    command: >
      sh -c "
        echo 'üöÄ Starting Android build...' &&
        echo 'Build type: $${BUILD_TYPE}' &&
        echo 'App name: $${APP_NAME}' &&
        
        # Install dependencies
        echo 'üì¶ Installing dependencies...' &&
        if [ -f yarn.lock ]; then
          yarn install --frozen-lockfile --network-timeout 600000
        else
          npm ci --legacy-peer-deps
        fi &&
        
        # Generate environment file for React Native
        echo '‚öôÔ∏è  Generating environment configuration...' &&
        cat > .env << EOF
        API_BASE_URL=$${API_BASE_URL}
        APP_ENV=$${BUILD_TYPE}
        SENTRY_DSN=$${SENTRY_DSN}
        FIREBASE_CONFIG=$${FIREBASE_CONFIG}
        APP_VERSION=$${APP_VERSION}
        BUILD_NUMBER=$${APP_VERSION_CODE}
        EOF &&
        
        # Build APK
        echo 'üî® Building APK...' &&
        cd android &&
        
        if [ \"$${BUILD_TYPE}\" = \"release\" ] && [ -n \"$${ANDROID_KEYSTORE_PASSWORD}\" ]; then
          echo 'üîê Building signed release APK...' &&
          ./gradlew clean assembleRelease --stacktrace --no-daemon \
            -PversionCode=$${APP_VERSION_CODE} \
            -PversionName=$${APP_VERSION} \
            -Pandroid.injected.signing.store.file=$${ANDROID_KEYSTORE_FILE} \
            -Pandroid.injected.signing.store.password=$${ANDROID_KEYSTORE_PASSWORD} \
            -Pandroid.injected.signing.key.alias=$${ANDROID_KEY_ALIAS} \
            -Pandroid.injected.signing.key.password=$${ANDROID_KEY_PASSWORD}
        else
          echo 'üîì Building debug APK...' &&
          ./gradlew clean assembleDebug --stacktrace --no-daemon \
            -PversionCode=$${APP_VERSION_CODE} \
            -PversionName=$${APP_VERSION}
        fi &&
        
        # Copy APK to output directory
        echo 'üì¶ Copying APK to output directory...' &&
        mkdir -p /home/reactnative/app/dist &&
        if [ \"$${BUILD_TYPE}\" = \"release\" ]; then
          cp app/build/outputs/apk/release/*.apk /home/reactnative/app/dist/ 2>/dev/null || true
        else
          cp app/build/outputs/apk/debug/*.apk /home/reactnative/app/dist/ 2>/dev/null || true
        fi &&
        
        # Generate build info
        echo 'üìÑ Generating build information...' &&
        TIMESTAMP=$$(date +'%Y%m%d_%H%M%S') &&
        APK_FILE=$$(ls /home/reactnative/app/dist/*.apk 2>/dev/null | head -1) &&
        if [ -f \"$${APK_FILE}\" ]; then
          APK_SIZE=$$(du -h \"$${APK_FILE}\" | cut -f1) &&
          APK_SHA256=$$(sha256sum \"$${APK_FILE}\" | cut -d' ' -f1) &&
          cat > /home/reactnative/app/dist/build-info.json << EOF
        {
          \"app_name\": \"$${APP_NAME}\",
          \"app_version\": \"$${APP_VERSION}\",
          \"build_type\": \"$${BUILD_TYPE}\",
          \"build_number\": \"$${APP_VERSION_CODE}\",
          \"timestamp\": \"$${TIMESTAMP}\",
          \"apk_size\": \"$${APK_SIZE}\",
          \"apk_sha256\": \"$${APK_SHA256}\",
          \"environment\": {
            \"node_version\": \"$$(node --version)\",
            \"npm_version\": \"$$(npm --version)\",
            \"react_native_version\": \"$$(grep '\"react-native\"' package.json | cut -d: -f2 | tr -d ',\" ')\",
            \"android_sdk_version\": \"$${ANDROID_SDK_VERSION}\"\n          }
        }
        EOF
        fi &&
        
        echo '‚úÖ Build completed successfully!' &&
        echo 'üìÅ APK location: /home/reactnative/app/dist/' &&
        ls -la /home/reactnative/app/dist/ 2>/dev/null || echo 'No APKs generated'
      "

  # ======================
  # APK TESTER / VERIFIER
  # ======================
  
  apk-verifier:
    <<: *common-build
    image: alpine:latest
    container_name: ecme-apk-verifier
    depends_on:
      - android-builder
    volumes:
      - ./dist/android:/apks:ro
    networks:
      - mobile-build-network
    command: >
      sh -c "
        echo 'üîç Verifying APK build...' &&
        sleep 10 &&
        
        if ls /apks/*.apk 1> /dev/null 2>&1; then
          echo '‚úÖ APK files found:' &&
          ls -lh /apks/*.apk &&
          echo '' &&
          
          # Check APK structure
          for apk in /apks/*.apk; do
            echo 'üìä Analyzing: $${apk}' &&
            apk_size=$$(du -h \"$${apk}\" | cut -f1) &&
            apk_sha256=$$(sha256sum \"$${apk}\" | cut -d' ' -f1) &&
            
            # Basic APK info (requires Java tools installed)
            if command -v aapt >/dev/null 2>&1; then
              apk_info=$$(aapt dump badging \"$${apk}\" 2>/dev/null | grep -E 'package|launchable-activity' | head -2) &&
              echo '   Package info:' &&
              echo \"   $${apk_info}\" | sed 's/^/   /'
            fi &&
            
            echo \"   Size: $${apk_size}\" &&
            echo \"   SHA256: $${apk_sha256:0:16}...\" &&
            echo ''
          done &&
          
          # Check build info
          if [ -f /apks/build-info.json ]; then
            echo 'üìÑ Build information:' &&
            cat /apks/build-info.json | python3 -m json.tool 2>/dev/null || cat /apks/build-info.json
          fi
        else
          echo '‚ùå No APK files found in /apks/' &&
          exit 1
        fi
      "

  # ======================
  # APK UPLOADER (Optional)
  # ======================
  
  apk-uploader:
    <<: *common-build
    image: curlimages/curl:latest
    container_name: ecme-apk-uploader
    depends_on:
      - android-builder
      - apk-verifier
    environment:
      UPLOAD_URL: ${APK_UPLOAD_URL}
      UPLOAD_TOKEN: ${APK_UPLOAD_TOKEN}
      UPLOAD_PATH: /releases/android
    volumes:
      - ./dist/android:/apks:ro
    networks:
      - mobile-build-network
    command: >
      sh -c "
        # Only run if upload URL is configured
        if [ -n \"$${UPLOAD_URL}\" ] && [ -n \"$${UPLOAD_TOKEN}\" ]; then
          echo 'üì§ Uploading APKs to: $${UPLOAD_URL}' &&
          
          for apk in /apks/*.apk; do
            if [ -f \"$${apk}\" ]; then
              filename=$$(basename \"$${apk}\") &&
              echo \"   Uploading: $${filename}\" &&
              
              # Upload APK
              response=$$(curl -s -w \"%{http_code}\" -X POST \
                \"$${UPLOAD_URL}$${UPLOAD_PATH}\" \
                -H \"Authorization: Bearer $${UPLOAD_TOKEN}\" \
                -H \"Content-Type: multipart/form-data\" \
                -F \"file=@$${apk}\" \
                -F \"filename=$${filename}\" \
                -o /tmp/upload-response.json) &&
              
              if [ \"$${response}\" = \"200\" ] || [ \"$${response}\" = \"201\" ]; then
                echo \"   ‚úÖ Upload successful (HTTP $${response})\"
              else
                echo \"   ‚ùå Upload failed (HTTP $${response})\" &&
                cat /tmp/upload-response.json 2>/dev/null || echo 'No response body'
              fi
            fi
          done
        else
          echo '‚ö†Ô∏è  APK upload skipped (no upload URL configured)'
        fi
      "

  # ======================
  # DEVELOPMENT SERVER (for testing)
  # ======================
  
  react-native-dev:
    <<: *common-build
    build:
      context: ./mobile-app
      dockerfile: Dockerfile.dev
    image: ecme-mobile-dev:latest
    container_name: ecme-react-native-dev
    environment:
      REACT_NATIVE_PACKAGER_HOSTNAME: localhost
      EXPO_DEVTOOLS_LISTEN_ADDRESS: 0.0.0.0
      NODE_ENV: development
      API_BASE_URL: http://host.docker.internal:3001
    ports:
      - "8081:8081" # Metro Bundler
      - "19000:19000" # Expo
      - "19001:19001" # Expo DevTools
      - "19002:19002" # Expo DevTools
    volumes:
      - ./mobile-app:/home/reactnative/app:rw
      - node_modules_cache:/home/reactnative/app/node_modules
      - /home/reactnative/app/.expo
    networks:
      - mobile-build-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: npx expo start --web

  # ======================
  # APK ANALYZER (Optional - for APK size optimization)
  # ======================
  
  apk-analyzer:
    <<: *common-build
    image: eclipse-temurin:11-jre
    container_name: ecme-apk-analyzer
    depends_on:
      - android-builder
    environment:
      APK_PATH: /apks/app-${BUILD_TYPE:-debug}.apk
    volumes:
      - ./dist/android:/apks:ro
      - ./tools/apk-analyzer:/tools:ro
    networks:
      - mobile-build-network
    command: >
      sh -c "
        if [ -f \"$${APK_PATH}\" ]; then
          echo 'üìä Analyzing APK size breakdown...' &&
          
          # Extract APK contents
          mkdir -p /tmp/apk-analysis &&
          unzip -q \"$${APK_PATH}\" -d /tmp/apk-analysis &&
          
          # Analyze file sizes
          echo 'File size breakdown (largest files):' &&
          find /tmp/apk-analysis -type f -exec du -h {} + | sort -rh | head -20 | sed 's/^/   /' &&
          
          echo '' &&
          echo 'Directory size breakdown:' &&
          du -h --max-depth=2 /tmp/apk-analysis | sort -rh | head -10 | sed 's/^/   /' &&
          
          # Cleanup
          rm -rf /tmp/apk-analysis
        else
          echo '‚ö†Ô∏è  APK not found for analysis: $${APK_PATH}'
        fi
      "

networks:
  mobile-build-network:
    driver: bridge
    name: mobile-build-network

volumes:
  android_sdk_cache:
    driver: local
  gradle_cache:
    driver: local
  node_modules_cache:
    driver: local
